name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Get dependencies
        run: go mod download

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          if [ "${{ matrix.goos }}" = "windows" ]; then
            BINARY_NAME="time-display-${{ matrix.goos }}-${{ matrix.goarch }}.exe"
          else
            BINARY_NAME="time-display-${{ matrix.goos }}-${{ matrix.goarch }}"
          fi
          go build -ldflags="-s -w" -o "$BINARY_NAME" main.go
          
          # åŽ‹ç¼©æ–‡ä»¶
          if [ "${{ matrix.goos }}" = "windows" ]; then
            zip "${BINARY_NAME}.zip" "$BINARY_NAME"
            echo "ASSET=${BINARY_NAME}.zip" >> $GITHUB_ENV
          else
            tar -czf "${BINARY_NAME}.tar.gz" "$BINARY_NAME"
            echo "ASSET=${BINARY_NAME}.tar.gz" >> $GITHUB_ENV
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.goos }}-${{ matrix.goarch }}
          path: ${{ env.ASSET }}
          retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # ç§»åŠ¨æ‰€æœ‰åŽ‹ç¼©åŒ…åˆ° release ç›®å½•
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} release/ \;
          
          echo "Release files:"
          ls -lh release/

      - name: Create sample config files
        run: |
          # åˆ›å»ºç¤ºä¾‹ config.json
          cat > config.json << 'EOF'
          {
            "datesFile": "dates.json",
            "sentencesFile": "sentences.json",
            "showDateAmount": 7,
            "dateFormat": "2006/01/02",
            "location": {
              "latitude": 39.9042,
              "longitude": 116.4074,
              "timezone": 8
            },
            "showSunTimes": true,
            "showDailySentence": true,
            "cacheDir": "cache",
            "sentenceUpdateMode": "count",
            "sentenceUpdateInterval": 5
          }
          EOF
          
          # åˆ›å»ºç¤ºä¾‹ dates.json
          cat > dates.json << 'EOF'
          {
            "events": [
              {
                "name": "æ˜¥èŠ‚",
                "type": "festival",
                "month": 1,
                "day": 1,
                "repeatYearly": true,
                "alwaysShow": true,
                "isLunar": true
              },
              {
                "name": "å›½åº†èŠ‚",
                "type": "festival",
                "month": 10,
                "day": 1,
                "repeatYearly": true,
                "alwaysShow": false,
                "isLunar": false
              }
            ]
          }
          EOF
          
          # åˆ›å»ºç¤ºä¾‹ sentences.json
          cat > sentences.json << 'EOF'
          {
            "sentences": [
              "ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å“¦ï¼",
              "ç”Ÿæ´»æ˜Žæœ—ï¼Œä¸‡ç‰©å¯çˆ±ã€‚",
              "æ˜Ÿå…‰ä¸é—®èµ¶è·¯äººï¼Œæ—¶å…‰ä¸è´Ÿæœ‰å¿ƒäººã€‚",
              "æ„¿ä½ èµ°å‡ºåŠç”Ÿï¼Œå½’æ¥ä»æ˜¯å°‘å¹´ã€‚",
              "ä¿æŒçƒ­çˆ±ï¼Œå¥”èµ´å±±æµ·ã€‚"
            ]
          }
          EOF
          
          # æ‰“åŒ…é…ç½®æ–‡ä»¶
          zip release/config-files.zip config.json dates.json sentences.json
          tar -czf release/config-files.tar.gz config.json dates.json sentences.json

      - name: Generate SHA256 checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          
          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿå’Œæž¶æž„é€‰æ‹©å¯¹åº”çš„æ–‡ä»¶ï¼š
          
          ### Windows
          - `time-display-windows-amd64.exe.zip` - Windows 64ä½
          
          ### Linux
          - `time-display-linux-amd64.tar.gz` - Linux 64ä½ (x86_64)
          - `time-display-linux-arm64.tar.gz` - Linux ARM64
          
          ### macOS
          - `time-display-darwin-amd64.tar.gz` - macOS Intel èŠ¯ç‰‡
          - `time-display-darwin-arm64.tar.gz` - macOS Apple Silicon (M1/M2/M3)
          
          ### é…ç½®æ–‡ä»¶
          - `config-files.zip` / `config-files.tar.gz` - ç¤ºä¾‹é…ç½®æ–‡ä»¶
          
          ### æ ¡éªŒæ–‡ä»¶
          - `SHA256SUMS` - æ‰€æœ‰æ–‡ä»¶çš„ SHA256 æ ¡éªŒå’Œ
          
          ---
          
          ## ðŸš€ å¿«é€Ÿå¼€å§‹
          
          ### Linux/macOS
          ```bash
          # ä¸‹è½½å¹¶è§£åŽ‹
          tar -xzf time-display-linux-amd64.tar.gz
          tar -xzf config-files.tar.gz
          
          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x time-display-linux-amd64
          
          # è¿è¡Œ
          ./time-display-linux-amd64
          ```
          
          ### Windows (PowerShell)
          ```powershell
          # è§£åŽ‹
          Expand-Archive time-display-windows-amd64.exe.zip
          Expand-Archive config-files.zip
          
          # è¿è¡Œ
          .\time-display-windows-amd64.exe
          ```
          
          ---
          
          ## ðŸ“– ä½¿ç”¨è¯´æ˜Ž
          
          ### æŸ¥çœ‹å¸®åŠ©
          ```bash
          ./time-display -h
          ```
          
          ### æ·»åŠ äº‹ä»¶
          ```bash
          # äº¤äº’å¼æ·»åŠ 
          ./time-display -add-event
          
          # æŒ‡å®šäº‹ä»¶åç§°
          ./time-display -add-event æ˜¥èŠ‚
          ```
          
          ### æ·»åŠ æ–‡æ¡ˆ
          ```bash
          ./time-display -add-sentence "ä½ çš„æ–‡æ¡ˆå†…å®¹"
          ```
          
          ### åˆ·æ–°æ–‡æ¡ˆ
          ```bash
          ./time-display -refresh-sentence
          ```
          
          ---
          
          ## ðŸ“ è¯¦ç»†æ–‡æ¡£
          
          å®Œæ•´ä½¿ç”¨è¯´æ˜Žè¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          
          ## ðŸ” æ–‡ä»¶æ ¡éªŒ
          
          ä¸‹è½½åŽå»ºè®®éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          ```bash
          sha256sum -c SHA256SUMS
          ```
          EOF
          
          {
            echo "notes<<RELEASE_NOTES_EOF"
            cat release_notes.md
            echo "RELEASE_NOTES_EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: release/*
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release (Manual)
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'workflow_dispatch'
        with:
          tag_name: manual-${{ github.run_number }}
          name: Manual Build #${{ github.run_number }}
          files: release/*
          body: ${{ steps.release_notes.outputs.notes }}
          draft: true
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}